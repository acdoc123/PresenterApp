<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="PresenterApp.Views.EditBookPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:model="clr-namespace:PresenterApp.Models"
    xmlns:vm="clr-namespace:PresenterApp.ViewModels"
    Title="{Binding Title}"
    x:DataType="vm:EditBookViewModel">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="10">

            <VerticalStackLayout IsVisible="{Binding IsEditingBookDetails}" Spacing="10">

                <Label FontAttributes="Bold" Text="Tên Sách" />
                <Entry Placeholder="Nhập tên sách..." Text="{Binding CurrentBook.Name}" />

                <Label FontAttributes="Bold" Text="Loại Sách" />
                <Picker
                    ItemDisplayBinding="{Binding Name}"
                    ItemsSource="{Binding BookTypes}"
                    SelectedItem="{Binding SelectedBookType}" />

                <Label FontAttributes="Bold" Text="Tags" />
                <Grid ColumnDefinitions="*,Auto">
                    <CollectionView
                        Grid.Column="0"
                        ItemsSource="{Binding SelectedTags}"
                        SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="model:Tag">
                                <Frame
                                    Margin="0,0,5,5"
                                    Padding="8,5"
                                    BorderColor="Gray"
                                    CornerRadius="8">
                                    <HorizontalStackLayout Spacing="5">
                                        <Label Text="{Binding Name}" VerticalOptions="Center" />
                                        <Button
                                            Padding="0"
                                            BackgroundColor="Transparent"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:EditBookViewModel}}, Path=RemoveTagFromBookCommand}"
                                            CommandParameter="{Binding}"
                                            HeightRequest="20"
                                            Text="x"
                                            TextColor="Gray"
                                            WidthRequest="20" />
                                    </HorizontalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.ItemsLayout>
                            <GridItemsLayout Orientation="Vertical" Span="3" />
                        </CollectionView.ItemsLayout>
                    </CollectionView>

                    <Button
                        Grid.Column="1"
                        Command="{Binding OpenTagSelectionModalCommand}"
                        CornerRadius="25"
                        FontSize="Large"
                        HeightRequest="45"
                        Text="+"
                        VerticalOptions="Start"
                        WidthRequest="45" />
                </Grid>
                <Button
                    Command="{Binding SaveBookCommand}"
                    HorizontalOptions="Fill"
                    Text="Lưu Sách" />
                <Button
                    BackgroundColor="Red"
                    Command="{Binding DeleteBookCommand}"
                    HorizontalOptions="Fill"
                    IsVisible="{Binding CurrentBook.Id, Converter={StaticResource IntToBoolConverter}}"
                    Text="Xóa Sách" />

                <Label
                    Margin="0,20,0,0"
                    FontAttributes="Bold"
                    FontSize="Medium"
                    Text="Thuộc tính" />

                <CollectionView ItemsSource="{Binding CommonAttributes}" SelectionMode="None">
                    <CollectionView.Header>
                        <Label FontAttributes="Italic" Text="Thuộc tính chung (từ Loại Sách):" />
                    </CollectionView.Header>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="model:AttributeDefinition">
                            <Grid Padding="0,5" ColumnDefinitions="*,*">
                                <Label Grid.Column="0" Text="{Binding Name}" />
                                <Label
                                    Grid.Column="1"
                                    Text="{Binding Type}"
                                    TextColor="Gray" />
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <Label
                    Margin="0,10,0,0"
                    FontAttributes="Italic"
                    Text="Thuộc tính riêng:" />
                <Grid ColumnDefinitions="*,*,Auto" ColumnSpacing="5">
                    <Entry
                        Grid.Column="0"
                        Placeholder="Tên thuộc tính"
                        Text="{Binding NewAttributeName}" />
                    <Picker
                        Title="Kiểu dữ liệu"
                        Grid.Column="1"
                        ItemsSource="{Binding FieldTypes}"
                        SelectedItem="{Binding NewAttributeType}" />
                    <Button
                        Grid.Column="2"
                        Command="{Binding AddPrivateAttributeCommand}"
                        Text="Thêm" />
                </Grid>

                <CollectionView
                    Margin="0,10,0,0"
                    ItemsSource="{Binding PrivateAttributes}"
                    SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="model:AttributeDefinition">
                            <Grid Padding="0,5" ColumnDefinitions="*,*,Auto">
                                <Label
                                    Grid.Column="0"
                                    Text="{Binding Name}"
                                    VerticalOptions="Center" />
                                <Label
                                    Grid.Column="1"
                                    Text="{Binding Type}"
                                    VerticalOptions="Center" />
                                <Button
                                    Grid.Column="2"
                                    BackgroundColor="Transparent"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:EditBookViewModel}}, Path=DeleteAttributeCommand}"
                                    CommandParameter="{Binding}"
                                    Text="Xóa"
                                    TextColor="Red" />
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </VerticalStackLayout>
            <Button
                Margin="0,0,0,10"
                Command="{Binding ToggleEditModeCommand}"
                HorizontalOptions="Start"
                IsEnabled="{Binding CurrentBook.Id, Converter={StaticResource IntToBoolConverter}}"
                IsVisible="{Binding IsEditingBookDetails, Converter={StaticResource InvertedBoolConverter}}"
                Text="Sửa thông tin sách" />


            <BoxView
                Margin="0,10"
                HeightRequest="1"
                Color="LightGray" />

            <Label
                FontAttributes="Bold"
                FontSize="Medium"
                Text="Nội dung Sách" />
            <Button
                Command="{Binding AddContentEntryCommand}"
                HorizontalOptions="Fill"
                IsEnabled="{Binding CurrentBook.Id, Converter={StaticResource IntToBoolConverter}}"
                Text="Thêm Nội dung Mới" />
            <Label
                FontAttributes="Italic"
                IsVisible="{Binding CurrentBook.Id, Converter={StaticResource IntToBoolConverter}, ConverterParameter=invert}"
                Text="Lưu sách trước khi thêm nội dung"
                TextColor="Gray" />

            <CollectionView
                Margin="0,10,0,0"
                ItemsSource="{Binding ContentEntries}"
                SelectionMode="None">
                <CollectionView.Header>
                    <Label FontAttributes="Italic" Text="Các nội dung đã thêm:" />
                </CollectionView.Header>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="model:ContentEntryViewModel">
                        <Grid Padding="0,5" ColumnDefinitions="*,Auto,Auto">
                            <Label
                                Grid.Column="0"
                                FontAttributes="Bold"
                                Text="{Binding SummaryText}"
                                VerticalOptions="Center" />
                            <Button
                                Grid.Column="1"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:EditBookViewModel}}, Path=EditContentEntryCommand}"
                                CommandParameter="{Binding}"
                                Text="Sửa" />
                            <Button
                                Grid.Column="2"
                                BackgroundColor="Transparent"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:EditBookViewModel}}, Path=DeleteContentEntryCommand}"
                                CommandParameter="{Binding}"
                                Text="Xóa"
                                TextColor="Red" />
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>