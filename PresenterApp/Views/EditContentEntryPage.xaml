<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="PresenterApp.Views.EditContentEntryPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:local="clr-namespace:PresenterApp.Views"
    xmlns:model="clr-namespace:PresenterApp.Models"
    xmlns:vm="clr-namespace:PresenterApp.ViewModels"
    Title="{Binding Title}"
    x:DataType="vm:EditContentEntryViewModel">

    <ContentPage.Resources>
        <ResourceDictionary>
            <DataTemplate x:Key="TextTemplate" x:DataType="vm:DynamicAttributeViewModel">
                <VerticalStackLayout Padding="0,10">
                    <Label FontAttributes="Bold" Text="{Binding DisplayName}" />
                    <Entry Placeholder="{Binding DisplayName}" Text="{Binding StringValue}" />
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="TextAreaTemplate" x:DataType="vm:DynamicAttributeViewModel">
                <VerticalStackLayout Padding="0,10">
                    <Label FontAttributes="Bold" Text="{Binding DisplayName}" />
                    <Editor
                        AutoSize="Disabled"
                        HeightRequest="150"
                        Placeholder="{Binding DisplayName}"
                        Text="{Binding StringValue}" />
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="NumberTemplate" x:DataType="vm:DynamicAttributeViewModel">
                <VerticalStackLayout Padding="0,10">
                    <Label FontAttributes="Bold" Text="{Binding DisplayName}" />
                    <Entry
                        Keyboard="Numeric"
                        Placeholder="{Binding DisplayName}"
                        Text="{Binding StringValue}" />
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="ImageTemplate" x:DataType="vm:DynamicAttributeViewModel">
                <VerticalStackLayout Padding="0,10" Spacing="5">
                    <Label FontAttributes="Bold" Text="{Binding DisplayName}" />

                    <Image
                        Aspect="AspectFit"
                        HeightRequest="150"
                        IsVisible="{Binding IsFileSelected}"
                        Source="{Binding StringValue}"
                        WidthRequest="150" />

                    <Button
                        Command="{Binding PickImageCommand}"
                        HorizontalOptions="Start"
                        IsVisible="{Binding IsFileSelected, Converter={StaticResource InvertedBoolConverter}}"
                        Text="Chọn Ảnh" />

                    <Button
                        BackgroundColor="Transparent"
                        Command="{Binding ClearFileCommand}"
                        HorizontalOptions="Start"
                        IsVisible="{Binding IsFileSelected}"
                        Text="Xóa Ảnh"
                        TextColor="Red" />
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="PdfTemplate" x:DataType="vm:DynamicAttributeViewModel">
                <VerticalStackLayout Padding="0,10" Spacing="5">
                    <Label FontAttributes="Bold" Text="{Binding DisplayName}" />

                    <Frame
                        Padding="10"
                        BorderColor="LightGray"
                        IsVisible="{Binding IsFileSelected}">
                        <HorizontalStackLayout Spacing="10">
                            <Label
                                FontAttributes="Italic"
                                Text="{Binding FileName}"
                                VerticalOptions="Center" />
                            <Button Command="{Binding OpenFileCommand}" Text="Mở File" />
                            <Button
                                BackgroundColor="Transparent"
                                Command="{Binding ClearFileCommand}"
                                Text="Xóa"
                                TextColor="Red" />
                        </HorizontalStackLayout>
                    </Frame>

                    <Button
                        Command="{Binding PickPdfCommand}"
                        HorizontalOptions="Start"
                        IsVisible="{Binding IsFileSelected, Converter={StaticResource InvertedBoolConverter}}"
                        Text="Chọn PDF" />
                </VerticalStackLayout>
            </DataTemplate>
            <DataTemplate x:Key="NamedTextListTemplate" x:DataType="vm:DynamicAttributeViewModel">
                <VerticalStackLayout Padding="0,10" Spacing="5">
                    <Label FontAttributes="Bold" Text="{Binding DisplayName}" />

                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding NamedEntryList}" Spacing="5">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="model:NamedTextEntry">
                                <Frame
                                    Padding="10"
                                    BorderColor="LightGray"
                                    CornerRadius="5">
                                    <Grid
                                        ColumnDefinitions="*,Auto"
                                        ColumnSpacing="5"
                                        RowDefinitions="Auto,*"
                                        RowSpacing="5">

                                        <Entry
                                            Grid.Row="0"
                                            Grid.Column="0"
                                            FontAttributes="Bold"
                                            Placeholder="Tên mục (ví dụ: 1, ĐK...)"
                                            Text="{Binding Name}" />

                                        <Button
                                            Grid.Row="0"
                                            Grid.Column="1"
                                            BackgroundColor="Transparent"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DynamicAttributeViewModel}}, Path=DeleteNamedEntryCommand}"
                                            CommandParameter="{Binding .}"
                                            Text="X"
                                            TextColor="Red"
                                            WidthRequest="40" />

                                        <Editor
                                            Grid.Row="1"
                                            Grid.Column="0"
                                            Grid.ColumnSpan="2"
                                            AutoSize="Disabled"
                                            HeightRequest="100"
                                            Placeholder="Nhập nội dung..."
                                            Text="{Binding Content}" />
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>

                    <Button
                        Margin="0,5,0,0"
                        Command="{Binding AddNewNamedEntryCommand}"
                        HorizontalOptions="Start"
                        Text="+ Thêm mục" />
                </VerticalStackLayout>
            </DataTemplate>
            <local:AttributeTemplateSelector
                x:Key="AttributeSelector"
                ImageTemplate="{StaticResource ImageTemplate}"
                NamedTextListTemplate="{StaticResource NamedTextListTemplate}"
                NumberTemplate="{StaticResource NumberTemplate}"
                PdfTemplate="{StaticResource PdfTemplate}"
                TextAreaTemplate="{StaticResource TextAreaTemplate}"
                TextTemplate="{StaticResource TextTemplate}" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*,Auto">
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="20" Spacing="5">
                <Label
                    FontAttributes="Bold"
                    FontSize="Medium"
                    Text="Thuộc tính Nội dung" />
                <VerticalStackLayout BindableLayout.ItemTemplateSelector="{StaticResource AttributeSelector}" BindableLayout.ItemsSource="{Binding DynamicAttributes}" />

                <BoxView
                    Margin="0,15"
                    HeightRequest="1"
                    Color="LightGray" />

                <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                    <Label
                        Grid.Column="0"
                        FontAttributes="Bold"
                        FontSize="Medium"
                        Text="Tags cho Nội dung này"
                        VerticalOptions="Center" />
                    <Button
                        Grid.Column="1"
                        Command="{Binding OpenTagSelectionModalCommand}"
                        IsEnabled="{Binding CurrentEntry.Id, Converter={StaticResource IntToBoolConverter}}"
                        Text="Quản lý Tags (+)" />
                </Grid>
                <Label
                    FontAttributes="Italic"
                    IsVisible="{Binding CurrentEntry.Id, Converter={StaticResource IntToBoolConverter}, ConverterParameter=invert}"
                    Text="Lưu nội dung trước khi thêm tag"
                    TextColor="Gray" />

                <CollectionView
                    Margin="0,5,0,0"
                    ItemsSource="{Binding SelectedTags}"
                    SelectionMode="None">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" Span="3" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="model:Tag">
                            <Frame
                                Margin="0,0,5,5"
                                Padding="8,5"
                                BorderColor="Gray"
                                CornerRadius="8">
                                <Label Text="{Binding Name}" VerticalOptions="Center" />
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>

        <Button
            Grid.Row="1"
            Margin="20"
            Command="{Binding SaveContentEntryCommand}"
            Text="Lưu Nội Dung" />
    </Grid>
</ContentPage>