<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="PresenterApp.Views.EditContentEntryPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:local="clr-namespace:PresenterApp.Views"
    xmlns:model="clr-namespace:PresenterApp.Models"
    xmlns:vm="clr-namespace:PresenterApp.ViewModels"
    Title="{Binding Title}"
    x:DataType="vm:EditContentEntryViewModel">

    <ContentPage.Resources>
        <ResourceDictionary>

            <DataTemplate x:Key="TextTemplate" x:DataType="vm:DynamicAttributeViewModel">
                <VerticalStackLayout Padding="0,10">
                    <Label FontAttributes="Bold" Text="{Binding DisplayName}" />
                    <Entry Placeholder="{Binding DisplayName}" Text="{Binding StringValue}" />
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="TextAreaTemplate" x:DataType="vm:DynamicAttributeViewModel">
                <VerticalStackLayout Padding="0,10">
                    <Label FontAttributes="Bold" Text="{Binding DisplayName}" />
                    <Editor
                        AutoSize="Disabled"
                        HeightRequest="150"
                        Placeholder="{Binding DisplayName}"
                        Text="{Binding StringValue}" />
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="NumberTemplate" x:DataType="vm:DynamicAttributeViewModel">
                <VerticalStackLayout Padding="0,10">
                    <Label FontAttributes="Bold" Text="{Binding DisplayName}" />
                    <Entry
                        Keyboard="Numeric"
                        Placeholder="{Binding DisplayName}"
                        Text="{Binding StringValue}" />
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="NamedTextBlockTemplate" x:DataType="model:FlexibleContentBlock">
                <Frame
                    Margin="0,5"
                    Padding="10"
                    BorderColor="LightGray"
                    CornerRadius="5">
                    <Grid
                        ColumnDefinitions="*,Auto"
                        RowDefinitions="Auto,*"
                        RowSpacing="5">
                        <Entry
                            Grid.Row="0"
                            Grid.Column="0"
                            FontAttributes="Bold"
                            Placeholder="Tên mục (ví dụ: 1, ĐK...)"
                            Text="{Binding Name}" />

                        <Button
                            Grid.Row="0"
                            Grid.Column="1"
                            BackgroundColor="Transparent"
                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DynamicAttributeViewModel}}, Path=DeleteBlockCommand}"
                            CommandParameter="{Binding .}"
                            Text="X"
                            TextColor="Red"
                            WidthRequest="40" />

                        <Editor
                            Grid.Row="1"
                            Grid.Column="0"
                            Grid.ColumnSpan="2"
                            AutoSize="Disabled"
                            HeightRequest="120"
                            Placeholder="Nhập nội dung..."
                            Text="{Binding Content}" />
                    </Grid>
                </Frame>
            </DataTemplate>

            <DataTemplate x:Key="ImageBlockTemplate" x:DataType="model:FlexibleContentBlock">
                <Frame
                    Margin="0,5"
                    Padding="10"
                    BorderColor="CornflowerBlue"
                    CornerRadius="5">
                    <Grid
                        ColumnDefinitions="*,Auto"
                        RowDefinitions="Auto,*"
                        RowSpacing="5">
                        <Label
                            Grid.Row="0"
                            Grid.Column="0"
                            FontAttributes="Bold"
                            Text="Hình ảnh" />
                        <Image
                            Grid.Row="1"
                            Grid.Column="0"
                            Aspect="AspectFit"
                            HeightRequest="200"
                            Source="{Binding FilePath}" />

                        <Button
                            Grid.Row="0"
                            Grid.Column="1"
                            BackgroundColor="Transparent"
                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DynamicAttributeViewModel}}, Path=DeleteBlockCommand}"
                            CommandParameter="{Binding .}"
                            Text="X"
                            TextColor="Red"
                            WidthRequest="40" />
                    </Grid>
                </Frame>
            </DataTemplate>

            <DataTemplate x:Key="PdfBlockTemplate" x:DataType="model:FlexibleContentBlock">
                <Frame
                    Margin="0,5"
                    Padding="10"
                    BorderColor="IndianRed"
                    CornerRadius="5">
                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="5">
                        <Label Grid.Column="0" VerticalOptions="Center">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span FontAttributes="Bold" Text="PDF: " />
                                    <Span Text="{Binding FileName}" />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        <Button
                            Grid.Column="1"
                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DynamicAttributeViewModel}}, Path=OpenFileCommand}"
                            CommandParameter="{Binding .}"
                            Text="Mở" />
                        <Button
                            Grid.Column="2"
                            BackgroundColor="Transparent"
                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DynamicAttributeViewModel}}, Path=DeleteBlockCommand}"
                            CommandParameter="{Binding .}"
                            Text="X"
                            TextColor="Red"
                            WidthRequest="40" />
                    </Grid>
                </Frame>
            </DataTemplate>

            <local:ContentBlockTemplateSelector
                x:Key="ContentBlockSelector"
                ImageBlockTemplate="{StaticResource ImageBlockTemplate}"
                NamedTextBlockTemplate="{StaticResource NamedTextBlockTemplate}"
                PdfBlockTemplate="{StaticResource PdfBlockTemplate}" />

            <DataTemplate x:Key="FlexibleContentTemplate" x:DataType="vm:DynamicAttributeViewModel">
                <VerticalStackLayout Padding="0,10" Spacing="5">
                    <Label FontAttributes="Bold" Text="{Binding DisplayName}" />

                    <HorizontalStackLayout
                        Padding="5"
                        BackgroundColor="LightGray"
                        Spacing="5">
                        <Label
                            FontAttributes="Bold"
                            Text="Thêm:"
                            VerticalOptions="Center" />
                        <Button
                            Command="{Binding AddNamedTextBlockCommand}"
                            FontSize="Small"
                            HeightRequest="40"
                            Text="+ Văn bản" />
                        <Button
                            Command="{Binding AddImageBlockCommand}"
                            FontSize="Small"
                            HeightRequest="40"
                            Text="+ Ảnh" />
                        <Button
                            Command="{Binding AddPdfBlockCommand}"
                            FontSize="Small"
                            HeightRequest="40"
                            Text="+ PDF" />
                    </HorizontalStackLayout>

                    <CollectionView
                        Margin="0,10,0,0"
                        ItemTemplate="{StaticResource ContentBlockSelector}"
                        ItemsSource="{Binding FlexibleContentList}"
                        SelectionMode="None">
                        <CollectionView.EmptyView>
                            <Label
                                Padding="10"
                                HorizontalOptions="Center"
                                Text="Nhấn nút + để thêm nội dung"
                                TextColor="Gray" />
                        </CollectionView.EmptyView>
                    </CollectionView>
                </VerticalStackLayout>
            </DataTemplate>

            <local:AttributeTemplateSelector
                x:Key="AttributeSelector"
                FlexibleContentTemplate="{StaticResource FlexibleContentTemplate}"
                NumberTemplate="{StaticResource NumberTemplate}"
                TextAreaTemplate="{StaticResource TextAreaTemplate}"
                TextTemplate="{StaticResource TextTemplate}" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*,Auto">
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="20" Spacing="5">

                <Label
                    FontAttributes="Bold"
                    FontSize="Medium"
                    Text="Thuộc tính Nội dung" />

                <VerticalStackLayout BindableLayout.ItemTemplateSelector="{StaticResource AttributeSelector}" BindableLayout.ItemsSource="{Binding DynamicAttributes}" />

            </VerticalStackLayout>
        </ScrollView>
        <Button
            Grid.Row="1"
            Margin="20"
            Command="{Binding SaveContentEntryCommand}"
            Text="Lưu Nội Dung" />
    </Grid>
</ContentPage>